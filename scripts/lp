#!/usr/bin/env python3
"""lp — Lean Playground CLI.

Local-first workspace tooling for QuantConnect Lean.
Runs backtests, creates projects, and browses algorithm examples
without requiring QuantConnect authentication.

Usage:
    lp backtest <project>              Run a backtest
    lp analyze <project>               Generate performance tearsheet
    lp create <name> [--from REF]      Create a new algorithm project
    lp browse [keyword]                Browse algorithm examples
    lp download [options]              Download historical data
    lp data list [options]             List available market data
    lp data info <symbol>              Show details for a symbol
    lp jupyter [--port PORT]           Start Jupyter Lab
    lp status                          Show workspace status
    lp update [--merge]                Sync with upstream repository
"""

import argparse
import logging
import sys
from pathlib import Path


def _cmd_backtest(args: argparse.Namespace) -> int:
    from lean_playground.backtest import run_backtest

    project_path = Path(args.project)
    parameters = _parse_parameters(args.params) if args.params else None
    return run_backtest(project_path, parameters=parameters)


def _parse_parameters(params: list[str]) -> dict[str, str]:
    """Parse key=value parameter pairs into a dict."""
    result = {}
    for param in params:
        if "=" not in param:
            raise ValueError(f"Invalid parameter format: {param}. Use key=value.")
        key, value = param.split("=", 1)
        result[key] = value
    return result


def _cmd_create(args: argparse.Namespace) -> int:
    from lean_playground.project import create_project

    try:
        create_project(args.name, from_reference=args.from_ref)
        return 0
    except (FileExistsError, FileNotFoundError) as e:
        print(f"Error: {e}", file=sys.stderr)
        return 1


def _cmd_browse(args: argparse.Namespace) -> int:
    from lean_playground.browse import browse, print_browse_results

    results = browse(args.keyword)
    print_browse_results(results)
    return 0


def _cmd_jupyter(args: argparse.Namespace) -> int:
    from lean_playground.jupyter import launch_jupyter

    return launch_jupyter(port=args.port)


def _cmd_status(args: argparse.Namespace) -> int:
    from lean_playground.status import print_status

    print_status()
    return 0


def _cmd_update(args: argparse.Namespace) -> int:
    from lean_playground.update import update_from_upstream

    return update_from_upstream(merge=args.merge)


def _cmd_data_list(args: argparse.Namespace) -> int:
    from lean_playground.data_inspect import scan_data_directory, format_data_list

    entries = scan_data_directory(
        asset_type=args.asset,
        market=args.market,
        resolution=args.resolution,
    )
    print(format_data_list(entries))
    return 0


def _cmd_data_info(args: argparse.Namespace) -> int:
    from lean_playground.data_inspect import get_symbol_info, format_symbol_info

    entries = get_symbol_info(
        symbol=args.symbol,
        asset_type=args.asset,
        market=args.market,
    )
    if not entries:
        print(f"No data found for symbol: {args.symbol}")
        return 1
    print(format_symbol_info(args.symbol, entries))
    return 0


def _cmd_download(args: argparse.Namespace) -> int:
    import asyncio
    from lean_playground.download import download_data

    # Set up logging
    log_level = getattr(logging, args.log_level.upper(), logging.INFO)
    logging.basicConfig(
        level=log_level,
        format="%(asctime)s - %(levelname)s - %(message)s",
    )

    try:
        result = asyncio.run(
            download_data(
                symbols=args.symbols,
                intervals=args.intervals,
                exchange=args.exchange,
                days=args.days,
                start_date=args.start_date,
                end_date=args.end_date,
                account_type=args.account_type,
                testnet=args.testnet,
            )
        )

        # Print summary
        total_files = sum(len(files) for files in result.values())
        print(f"\nDownload complete: {total_files} file(s) written")
        for symbol, files in result.items():
            if files:
                print(f"  {symbol}: {len(files)} file(s)")

        return 0
    except Exception as e:
        print(f"Error: {e}", file=sys.stderr)
        return 1


def _cmd_analyze(args: argparse.Namespace) -> int:
    from lean_playground.analyze import analyze_backtest

    try:
        analyze_backtest(
            project=args.project,
            backtest_timestamp=args.backtest,
            benchmark=args.benchmark,
        )
        return 0
    except (FileNotFoundError, ValueError) as e:
        print(f"Error: {e}", file=sys.stderr)
        return 1


def main() -> int:
    parser = argparse.ArgumentParser(
        prog="lp",
        description="Lean Playground — local-first workspace tooling for QuantConnect Lean.",
    )
    subparsers = parser.add_subparsers(dest="command", required=True)

    # backtest
    p_backtest = subparsers.add_parser(
        "backtest",
        help="Run a backtest using the Lean engine directly",
    )
    p_backtest.add_argument(
        "project",
        help="Path to the algorithm project directory (e.g., algorithms/sample_sma_crossover)",
    )
    p_backtest.add_argument(
        "-p", "--param",
        dest="params",
        action="append",
        metavar="KEY=VALUE",
        help="Algorithm parameter (can be repeated). E.g., -p symbol=SPY -p asset_type=equity",
    )
    p_backtest.set_defaults(func=_cmd_backtest)

    # create
    p_create = subparsers.add_parser(
        "create",
        help="Create a new algorithm project",
    )
    p_create.add_argument(
        "name",
        help="Project name or path (e.g., 'my_algo' or 'algorithms/my_algo')",
    )
    p_create.add_argument(
        "--from",
        dest="from_ref",
        metavar="REF",
        default=None,
        help="Copy from an algorithm example (e.g., MACDTrendAlgorithm)",
    )
    p_create.set_defaults(func=_cmd_create)

    # browse
    p_browse = subparsers.add_parser(
        "browse",
        help="Browse algorithm examples from the Lean repository",
    )
    p_browse.add_argument(
        "keyword",
        nargs="?",
        default=None,
        help="Optional keyword to filter algorithms",
    )
    p_browse.set_defaults(func=_cmd_browse)

    # jupyter
    p_jupyter = subparsers.add_parser(
        "jupyter",
        help="Start Jupyter Lab with Lean research environment",
    )
    p_jupyter.add_argument(
        "--port",
        type=int,
        default=8888,
        help="Port for Jupyter Lab (default: 8888)",
    )
    p_jupyter.set_defaults(func=_cmd_jupyter)

    # status
    p_status = subparsers.add_parser(
        "status",
        help="Show workspace status",
    )
    p_status.set_defaults(func=_cmd_status)

    # update
    p_update = subparsers.add_parser(
        "update",
        help="Sync with upstream lean-playground repository",
        formatter_class=argparse.RawDescriptionHelpFormatter,
        description="""Sync your fork with the upstream lean-playground repository.

By default, uses rebase mode which keeps a linear history and automatically
skips cherry-picked commits. Use --merge when others contribute to your fork.

Examples:
    lp update              # Rebase mode (default, recommended)
    lp update --merge      # Merge mode (preserves branch topology)
""",
    )
    p_update.add_argument(
        "--merge",
        action="store_true",
        help="Use merge instead of rebase (for collaborative forks)",
    )
    p_update.set_defaults(func=_cmd_update)

    # download
    p_download = subparsers.add_parser(
        "download",
        help="Download historical data from exchanges to Lean format",
        formatter_class=argparse.RawDescriptionHelpFormatter,
        description="""Download historical OHLCV data from Binance or Bybit.

Data is written in QuantConnect Lean format to /Lean/Data for use with backtests.

Examples:
    lp download --symbols BTCUSDT                     # Last 10 days, 1m and 1h
    lp download --symbols BTCUSDT ETHUSDT --days 30   # Multiple symbols
    lp download --symbols BTCUSDT --intervals 1d     # Daily data only
    lp download --symbols BTCUSDT --start-date 2024-01-01
    lp download --symbols BTCUSDT --account-type usdt_future  # Futures data
""",
    )
    p_download.add_argument(
        "--symbols",
        type=str,
        nargs="+",
        default=["BTCUSDT"],
        help="Symbols to download (default: BTCUSDT)",
    )
    p_download.add_argument(
        "--intervals",
        type=str,
        nargs="+",
        default=["1m", "1h"],
        help="Intervals to download (default: 1m 1h). Options: 1s, 1m, 5m, 15m, 30m, 1h, 4h, 1d",
    )
    p_download.add_argument(
        "--exchange",
        type=str,
        default="binance",
        choices=["binance"],
        help="Exchange to download from (default: binance)",
    )
    p_download.add_argument(
        "--days",
        type=int,
        default=10,
        help="Days of data to download if no dates specified (default: 10)",
    )
    p_download.add_argument(
        "--start-date",
        type=str,
        default=None,
        help="Start date (YYYY-MM-DD)",
    )
    p_download.add_argument(
        "--end-date",
        type=str,
        default=None,
        help="End date (YYYY-MM-DD)",
    )
    p_download.add_argument(
        "--account-type",
        type=str,
        default="spot",
        choices=["spot", "margin", "usdt_future", "coin_future"],
        help="Account type (default: spot). Use usdt_future for perpetual futures.",
    )
    p_download.add_argument(
        "--testnet",
        action="store_true",
        help="Use testnet endpoints",
    )
    p_download.add_argument(
        "--log-level",
        type=str,
        default="INFO",
        choices=["DEBUG", "INFO", "WARNING", "ERROR"],
        help="Logging level (default: INFO)",
    )
    p_download.set_defaults(func=_cmd_download)

    # data (parent command with subcommands)
    p_data = subparsers.add_parser(
        "data",
        help="Inspect available market data",
        formatter_class=argparse.RawDescriptionHelpFormatter,
        description="""Inspect available market data in the Lean data directory.

Use 'lp data list' to see all available data, or 'lp data info <symbol>'
to get details for a specific symbol.
""",
    )
    data_subparsers = p_data.add_subparsers(dest="data_command", required=True)

    # data list
    p_data_list = data_subparsers.add_parser(
        "list",
        help="List available data",
        formatter_class=argparse.RawDescriptionHelpFormatter,
        description="""List all available market data with optional filters.

Examples:
    lp data list                           # List all data
    lp data list --asset crypto            # Filter by asset type
    lp data list --market binance          # Filter by market
    lp data list --resolution daily        # Filter by resolution
""",
    )
    p_data_list.add_argument(
        "--asset",
        help="Filter by asset type (equity, crypto, forex, future, option)",
    )
    p_data_list.add_argument(
        "--market",
        help="Filter by market/exchange (usa, binance, oanda, comex, etc.)",
    )
    p_data_list.add_argument(
        "--resolution",
        help="Filter by resolution (daily, hour, minute, second, tick)",
    )
    p_data_list.set_defaults(func=_cmd_data_list)

    # data info
    p_data_info = data_subparsers.add_parser(
        "info",
        help="Show details for a specific symbol",
        formatter_class=argparse.RawDescriptionHelpFormatter,
        description="""Show detailed information for a specific symbol.

Examples:
    lp data info btcusdt                   # Show all data for BTCUSDT
    lp data info spy --asset equity        # Filter by asset type
    lp data info btcusdt --market binance  # Filter by market
""",
    )
    p_data_info.add_argument(
        "symbol",
        help="Symbol to inspect (e.g., BTCUSDT, SPY, EURUSD)",
    )
    p_data_info.add_argument(
        "--asset",
        help="Filter by asset type",
    )
    p_data_info.add_argument(
        "--market",
        help="Filter by market/exchange",
    )
    p_data_info.set_defaults(func=_cmd_data_info)

    # analyze
    p_analyze = subparsers.add_parser(
        "analyze",
        help="Generate performance tearsheet from backtest results",
        formatter_class=argparse.RawDescriptionHelpFormatter,
        description="""Generate an HTML tearsheet from backtest results.

The report includes equity curve, drawdown analysis, monthly returns heatmap,
and key risk metrics (Sharpe, Sortino, etc.).

Examples:
    lp analyze sr_levels                              # Latest backtest
    lp analyze sr_levels --backtest 20260129-215353   # Specific backtest
    lp analyze sr_levels --benchmark BTC-USD          # With benchmark
""",
    )
    p_analyze.add_argument(
        "project",
        help="Project name or path (e.g., 'sr_levels' or 'algorithms/sr_levels')",
    )
    p_analyze.add_argument(
        "--backtest",
        dest="backtest",
        metavar="TIMESTAMP",
        default=None,
        help="Specific backtest timestamp (default: latest)",
    )
    p_analyze.add_argument(
        "--benchmark",
        dest="benchmark",
        metavar="TICKER",
        default=None,
        help="Benchmark ticker for comparison (e.g., BTC-USD, SPY)",
    )
    p_analyze.set_defaults(func=_cmd_analyze)

    args = parser.parse_args()
    return args.func(args)


if __name__ == "__main__":
    sys.exit(main())
